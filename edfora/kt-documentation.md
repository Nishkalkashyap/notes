---
title : KT-documentation
description : KT-documentation
tags : []
sidebar : false
pageClass: hide-sagar
---

# KT-documentation

[[toc]]

## Notes on Mypat frontend

### How we webpack in Angular's build process
**Mypat frontend** is built on top of Angular 4, which does not has native support for injecting custom webpack config in the build process unlike Angular version 6+. We can use `ng eject` command to expose a custom webpack config but that comes with its own demerits. 

So to include webpack in our build process, we improvised and created our own way which works by modifying the `@angular/cli` package and changing angular's build scripts. 

To do this every time after a fresh `npm install` would be tedious, so we automated the process as follows:

1. We add a `postinstall` hook in our `package.json` file. This hook will run every time you run an `npm install` in the project.
    ```json
    "postinstall": "ts-node --skip-project ./scripts/generate-webpack-config.ts"
    ```
2. In the `postinstall` hook we run a script that modifies the angular's native build config and injects the path to our custom webpack config. The script looks as follows:

    ```ts
    // ./scripts/generate-webpack-config.ts
    import * as  fs from 'fs';

    const WEBPACK_CONFIG_PATH = './node_modules/@angular/cli/models/webpack-config.js';
    const baseWebpackConfig = fs.readFileSync(WEBPACK_CONFIG_PATH).toString();

    const stringToReplace = 'this.config = webpackMerge(webpackConfigs);';
    const newString = 'this.config = webpackMerge(webpackConfigs.concat(require(path.join(process.cwd(), "./base-webpack.config.js"))));';

    if (baseWebpackConfig.indexOf(stringToReplace) !== -1) {
        console.log('Injecting custom webpack config in angular');
        const replacedFile = baseWebpackConfig.replace(stringToReplace, newString);
        fs.writeFileSync(WEBPACK_CONFIG_PATH, replacedFile);
        console.log('Successfully injected custom webpack config in angular');
    } else {
        console.log('Config already injected');
    }
    ```
3. No we can export a webpack config from the path `./base-webpack.config.js`, which will be included by angular in development as well as build time.

!!! warning Gotcha!
The above works under the assumption that we are strictly using `@angular/cli` version `1.3.1`. If in future, we change the package version _(highly unlikely to happen unless we change angular version)_ to something other than this, this code will not work.
!!!

### How we add service worker
We add service worker in the website using the webpack plugin `workbox-webpack-plugin` in our webpack config. Mainly, we are using service worker for client side caching. Generating and using service worker works as follows:

1. At the build time, service worker and a precache manifest is generated by webpack.
2. In the `main.ts` file of the project, we include the service worker as follows:
    ```ts
    // ./src/main.ts
    function addServiceWorker() {
    navigator.serviceWorker.register('/service-worker.js').then(registration => {
        console.log('SW registered: ', registration);
    }).catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
    });
    }
    ```
3. If need be, you can remove the service worker from the website with:
    ```ts
    // ./src/main.ts
    /**
     * The following will remove service worker and clear all associated caches
     * Use this for hard reset of website in case of dead-worker
     */
    function removeServiceWorker() {
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
            for (const registration of registrations) {
                registration.unregister();
            }
            console.log('Service Worker unregistered successfully');
        }).catch((err) => {
            console.log('Service Worker failed to unregister', err);
        });

        // clearing cache
        caches.keys().then(function (names) {
            for (const name of names) {
            caches.delete(name);
            }
            console.log('Caches cleared successfully');
        }).catch((err) => {
            console.log('Failed to clear caches', err);
        });
    }
    ```

### How we handle image compression
At the time of the build, we do lossy image compression to compress the size of images, this is again done using webpack. Check out the rest of the config here - `./base-webpack.config.js`

## Notes on Documentation website
The idea of this documentation website is to bring all the technical documentation of the organization at one place. It is a statically built website and works on top of the `Vue.js` and `Vuepress` framework. Check out the getting started guide to see the development and build process. 

Here I share the deploy process, for the admins of this repo. The website will be deployed on `docs.mypat.org` bucket on S3, which is mapped through cloudflare DNS and makes the website accessible at `https://docs.mypat.org`.

### Setting the environment variables
Set the following environment variables in the project at `./docs/.env`
```
aws_access_key_id=
aws_secret_access_key=
```

### Deploy process
1. `git clone https://your-bitBucket-handle@bitbucket.org/edfora/documentation.git`
2. `cd ./documentation/docs`
3. `npm install`
4. `npm run build`
5. `npm run deploy`

### Restricting website access
Since the website could contain some confidential data and content of the organization, we implement an ip address access filter. Only the ones accessing the website through organization's internal internal IP will be able to access the website.

The IP address filter is implemented using cloudflare workers as follows:




<!-- ## Notes on cloudflare

### DNS resolver and the concept of DNS proxy
At its core, cloudflare is a reverse proxy. 
![](/edfora/cf-1.jpg) -->

